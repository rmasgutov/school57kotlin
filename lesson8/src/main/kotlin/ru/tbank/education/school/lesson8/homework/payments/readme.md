# Null-safety. Unit - тестирование

## Тестирование системы обработки платежей

### Описание

Вы разрабатываете модуль тестирования для системы обработки платежей.
Ваша задача — **написать полный набор юнит-тестов** для класса `PaymentProcessor`, обеспечив высокое покрытие кода.
Цель - 90% и более покрытия по строкам (line coverage) и по ветвлениям (branch coverage)

Покрытие проверяется с помощью **JaCoCo**.

---

### Дедлайн и условия прохождения задания

**Дедлайн: 28 ноября 2025 года, 23:59 по московскому времени**

Задание, сданное после дедлайна, **не принимается**.

Для успешного прохождения задания необходимо:

1. Написать тесты в классе `PaymentProcessorTest`
2. Достичь **минимум 90% покрытия по строкам** (line coverage) в классе `PaymentProcessor`
3. Достичь **минимум 90% покрытия по ветвлениям** (branch coverage) в классе `PaymentProcessor`
4. Наличие тест-кейсов из пункта `Что нужно протестировать`
---

### Классы для тестирования

Все классы находятся в пакете `ru.tbank.education.school.lesson8.homework.payments`:

| Класс | Назначение |
|------|-----------|
| `PaymentProcessor` | Основной класс — обработка платежей, валидация, конвертация, шлюз |
| `PaymentResult` | Результат операции: статус и сообщение |
| `PaymentData` | Данные для пакетной обработки платежей |
| `GatewayResult` | Результат имитации работы внешнего платёжного шлюза |

---

### Требования к тестам

#### 1. Местоположение тестов
Все тесты должны быть написаны в классе `ru.tbank.education.school.lesson8.homework.payments.PaymentProcessorTest`

#### 2. Что нужно протестировать

##### Валидация входных данных:
- Сумма > 0
- Номер карты: 13–19 цифр, только цифры, не пустой
- Срок действия: месяц (1–12), год, не просрочен
- Валюта и customerId не пустые

##### Безопасность:
- Обнаружение подозрительных карт (префиксы: 4444, 5555, 1111, 9999)
- Проверка номера карты по алгоритму Луна

##### Конвертация валют:
- Поддерживаемые: USD, EUR, GBP, JPY, RUB
- Неподдерживаемые — предупреждение, используется USD

##### Логика шлюза:
- Успешная оплата
- Ошибки: "insufficient funds", "card blocked", "transaction limit", "timeout"

##### Пакетная обработка (bulkProcess):
- Пустой список
- Список с валидными и невалидными платежами
- Обработка исключений внутри цикла
- Логирование итогов

##### Дополнительные методы:
- calculateLoyaltyDiscount — проверка уровней скидок и ограничений

##### Исключения:
- IllegalArgumentException при невалидных данных
- Обработка исключений в bulkProcess

---

### Проверка покрытия

Запустите тесты и сгенерируйте отчёт:
```bash
./gradlew lesson8:clean lesson8:test lesson8:jacocoTestReport
```

Откройте отчёт в браузере:
`build/reports/jacoco/test/html/index.html`

Убедитесь, что:
- Line Coverage для класса `PaymantProcessor` ≥ 90%
- Branch Coverage для класса `PaymantProcessor` ≥ 90%